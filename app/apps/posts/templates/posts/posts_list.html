{% extends "base/base.html" %}
{% load static %}

{% block title %}Posts{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/posts.css' %}?v=20260202-1008">
<link rel="stylesheet" href="{% static 'css/posts-detail.css' %}?v=20260202-1323">
<link rel="stylesheet" href="{% static 'css/confirm-modal.css' %}?v=20260202-1008">
<link rel="stylesheet" href="{% static 'css/toaster.css' %}?v=20260202-1008">
{% endblock %}

{% block content %}
<div class="mb-6">
    <!-- Header Principal (igual p√°gina Pautas) -->
    <div class="perfil-header mb-6">
        <div class="header-content">
            <div class="header-text">
                <h1 class="text-3xl font-bold mb-2">üé® Posts</h1>
                <p class="text-lg opacity-90">
                    Gere posts completos com imagem e legenda usando IA baseada na sua identidade visual 
                    para criar conte√∫do profissional e engajador para suas redes sociais.
                </p>
            </div>
            <div class="header-actions">
                <button type="button" class="btn btn-light btn-lg" onclick="document.getElementById('modalGerarPost').style.display='block'">
                    <i class="fas fa-magic mr-2"></i>
                    Gerar Post
                </button>
            </div>
        </div>
    </div>
    
    <!-- Filtros (igual p√°gina Pautas) -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-6">
            <h3 class="block-title mb-4">
                <i class="fas fa-filter mr-2"></i>
                Filtros
            </h3>
            <form method="get" class="w-full">
                <div class="flex items-center gap-4 w-full">
                    <!-- Campo Data -->
                    <div style="width: 200px; flex-shrink: 0;">
                        <input type="date" name="data" id="filtroData" class="form-input-filter" 
                               value="{{ filtros.data|default:'' }}" placeholder="Data">
                    </div>
                    
                    <!-- Campo Status -->
                    <div style="width: 200px; flex-shrink: 0;">
                        <select name="status" id="filtroStatus" class="form-input-filter">
                            <option value="all">Todos os status</option>
                        </select>
                    </div>
                    
                    <!-- Campo Buscar por T√≠tulo -->
                    <div style="flex: 1; min-width: 0;">
                        <div class="form-input-wrapper">
                            <input type="text" name="search" id="filtroBusca" class="form-input-filter" 
                                   value="{{ filtros.search|default:'' }}" placeholder="Buscar por t√≠tulo...">
                            <i class="fas fa-search form-input-icon"></i>
                        </div>
                    </div>
                    
                    <!-- Bot√µes de A√ß√£o -->
                    <div class="flex gap-3" style="flex-shrink: 0;">
                        <button type="button" id="btnBuscarTitulo" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                            Buscar
                        </button>
                        <button type="button" id="btnLimparFiltros" class="btn btn-outline-secondary">
                            <i class="fas fa-eraser"></i>
                            Limpar filtro
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Pagina√ß√£o (sempre vis√≠vel) -->
    <div class="mb-6" style="background: #1f2937; border-radius: 8px; padding: 16px; display: flex; justify-content: space-between; align-items: center;">
        <div style="color: #9ca3af; font-size: 14px;" id="postPagerInfo">
            P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }} ({{ page_obj.paginator.count }} posts)
        </div>
        
        <div style="display: flex; gap: 8px; align-items: center;" id="pagerButtons">
            <!-- Primeira p√°gina -->
            <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               style="padding: 8px 12px; background: {% if page_obj.number == 1 %}#6366f1{% else %}transparent{% endif %}; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                ¬´
            </a>
            
            <!-- P√°gina anterior -->
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               style="padding: 8px 12px; background: transparent; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                ‚Äπ
            </a>
            {% endif %}
            
            <!-- N√∫meros de p√°gina -->
            {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                    <span style="padding: 8px 12px; background: #6366f1; border: 1px solid #6366f1; border-radius: 6px; color: #fff; min-width: 40px; text-align: center; font-weight: 500;">
                        {{ num }}
                    </span>
                {% elif num > page_obj.number|add:'-4' and num < page_obj.number|add:'4' %}
                    <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       style="padding: 8px 12px; background: transparent; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                        {{ num }}
                    </a>
                {% endif %}
            {% endfor %}
            
            <!-- Pr√≥xima p√°gina -->
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               style="padding: 8px 12px; background: transparent; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                ‚Ä∫
            </a>
            {% endif %}
            
            <!-- √öltima p√°gina -->
            <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               style="padding: 8px 12px; background: {% if page_obj.number == page_obj.paginator.num_pages %}#6366f1{% else %}transparent{% endif %}; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                ¬ª
            </a>
        </div>
    </div>
    
    <!-- Estado Vazio -->
    <div class="posts-empty" id="postsEmpty" {% if page_obj %}style="display:none"{% endif %}>
        <div class="text-center py-12">
            <i class="fas fa-images text-6xl text-muted mb-4"></i>
            <h4 class="text-xl text-muted mb-2">Nenhum post encontrado</h4>
            <p class="text-muted">
                {% if knowledge_base %}
                    Clique em "Gerar Post" para criar seu primeiro post com IA.
                {% else %}
                    Complete o perfil da sua empresa para come√ßar a gerar posts.
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Conte√∫do Principal: Grid 2 Colunas -->
    <div class="posts-main" id="postsMain" {% if not page_obj %}style="display:none"{% endif %}>
        {% if page_obj %}
        {% with post=page_obj.0 %}
        <div class="posts-columns">
            <!-- Coluna Esquerda: Detalhes do Post -->
            <article class="post-details card pad" id="postDetails">
                <!-- Status Pill -->
                <div>
                    <span class="status-pill is-pending" id="postStatus" data-status="{{ post.status }}" data-post-id="{{ post.id }}">
                        {{ post.get_status_display }}
                    </span>
                </div>

                <!-- Tags (Rede Social, Formato, Carrossel) -->
                <div class="post-tags" id="postTags">
                    <span class="post-tag">{{ post.get_social_network_display }}</span>
                    {% if post.primary_format %}
                    <span class="post-tag">{{ post.primary_format|upper }}</span>
                    {% endif %}
                    {% if post.is_carousel %}
                    <span class="post-tag">CARROSSEL - {{ post.image_count }} IMAGENS</span>
                    {% endif %}
                </div>

                <!-- T√≠tulo -->
                <div class="post-section">
                    <h4>T√≠tulo</h4>
                    <p id="postTitulo">{{ post.title|default:"‚Äî" }}</p>
                </div>

                <!-- Subt√≠tulo -->
                <div class="post-section">
                    <h4>Subt√≠tulo</h4>
                    <p id="postSubtitulo">{{ post.subtitle|default:"‚Äî" }}</p>
                </div>

                <!-- Legenda -->
                <div class="post-section">
                    <h4>Legenda</h4>
                    <p id="postLegenda">{{ post.caption|default:"‚Äî" }}</p>
                </div>

                <!-- Hashtags -->
                <div class="post-section">
                    <h4>Hashes</h4>
                    <p id="postHashtags">{% if post.hashtags %}{{ post.hashtags|join:" " }}{% else %}‚Äî{% endif %}</p>
                </div>

                <!-- CTA -->
                <div class="post-section">
                    <h4>CTA</h4>
                    <p id="postCTA">{{ post.cta|default:"‚Äî" }}</p>
                </div>

                <!-- Descri√ß√£o da Imagem -->
                <div class="post-section">
                    <h4>Descri√ß√£o da imagem a ser gerada</h4>
                    <p id="postDescricaoImagem" {% if post.is_carousel and post.image_count > 1 %}class="post-image-prompt"{% endif %}>
                        {{ post.image_prompt|default:"‚Äî" }}
                    </p>
                </div>

                <!-- Caixa de Solicita√ß√£o de Altera√ß√£o de Texto -->
                <div class="post-request" id="textRequestBox" hidden>
                    <label class="sr-only" for="textRequestInput">Solicita√ß√£o de altera√ß√£o</label>
                    <textarea id="textRequestInput" maxlength="400" placeholder="Digite aqui o que gostaria de alterar..."></textarea>
                    <div class="request-actions">
                        <button type="button" class="btn ghost" data-action="cancel-text-request">Cancelar</button>
                        <button type="button" class="btn" data-action="submit-text-request">Enviar</button>
                    </div>
                </div>

                <!-- Footer -->
                <div class="post-footer">
                    <div id="postRevisoes">Revis√µes restantes: {{ post.revisions_remaining|default:0 }}</div>
                    <div id="postDataCriacao">Data da cria√ß√£o: {{ post.created_at|date:"d/m/Y H:i" }}</div>
                </div>

                <!-- A√ß√µes Din√¢micas -->
                <div class="post-actions" id="postActions"></div>
            </article>

            <!-- Coluna Direita: Visual/Imagem -->
            <aside class="post-visual card pad" id="postVisual">
                <!-- Frame de Imagem -->
                <div class="post-image-frame" id="postImageFrame">
                    {% if post.images.exists %}
                        {% with first_image=post.images.first %}
                        <img src="#" alt="Imagem do post" data-lazy-load="{{ first_image.s3_key }}" class="post-main-image">
                        {% endwith %}
                    {% else %}
                    <span class="placeholder">SEM IMAGEM GERADA</span>
                    {% endif %}
                </div>

                <!-- Galeria de Miniaturas (para m√∫ltiplas imagens) -->
                {% if post.images.count > 1 %}
                <div class="post-gallery" id="postGallery">
                    {% for img in post.images.all %}
                    <button type="button" class="gallery-thumb {% if forloop.first %}active{% endif %}" data-image-index="{{ forloop.counter0 }}" data-s3-key="{{ img.s3_key }}">
                        <img src="#" alt="Miniatura {{ forloop.counter }}" data-lazy-load="{{ img.s3_key }}">
                    </button>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- A√ß√µes Visuais -->
                <div class="post-visual-actions" id="postImageActions"></div>

                <!-- Caixa de Solicita√ß√£o de Altera√ß√£o de Imagem -->
                <div class="post-request" id="imageRequestBox" hidden>
                    <label class="sr-only" for="imageRequestInput">Solicita√ß√£o de altera√ß√£o da imagem</label>
                    <textarea id="imageRequestInput" maxlength="400" placeholder="Digite aqui o que gostaria de alterar na imagem..."></textarea>
                    <div class="request-actions">
                        <button type="button" class="btn ghost" data-action="cancel-image-request">Cancelar</button>
                        <button type="button" class="btn" data-action="submit-image-request">Enviar</button>
                    </div>
                </div>
            </aside>
        </div>
        {% endwith %}
        {% endif %}
    </div>
</div>

<!-- Modal Gerar Post -->
<div id="modalGerarPost" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-gerar-post">
        <div class="modal-header">
            <h3>Gerar Posts</h3>
            <button type="button" class="modal-close" onclick="closeModal('modalGerarPost')">√ó</button>
        </div>
        
        <form id="formGerarPost" class="modal-body">
            <!-- LINHA 1: Rede Social + Formato (Grid 2 colunas) -->
            <div class="modal-row-grid">
                <div class="field">
                    <label for="redePost">
                        Rede Social
                        <span class="text-danger">*</span>
                    </label>
                    <select id="redePost" name="rede_social" class="form-input-filter" required>
                        <option value="">Selecione...</option>
                        <option value="instagram">Instagram</option>
                        <option value="facebook">Facebook</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="whatsapp">WhatsApp</option>
                    </select>
                </div>
                
                <div class="field">
                    <label>Formato</label>
                    <div class="format-options" id="formatOptions" role="radiogroup">
                        <label class="chip-choice active">
                            <input type="radio" name="formatOption" value="feed" checked>
                            <span>Feed</span>
                        </label>
                        <label class="chip-choice">
                            <input type="radio" name="formatOption" value="stories">
                            <span>Stories</span>
                        </label>
                        <label class="chip-choice">
                            <input type="radio" name="formatOption" value="both">
                            <span>Feed + Stories</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- LINHA 2: CTA + Carrossel + Qtd (Grid 3 colunas) -->
            <div class="modal-row-grid-3">
                <div class="field">
                    <label>Call to Action (CTA)</label>
                    <div class="cta-toggle-group">
                        <label class="cta-toggle-option active">
                            <input type="radio" name="ctaOption" value="sim" checked>
                            <span>Sim</span>
                        </label>
                        <label class="cta-toggle-option">
                            <input type="radio" name="ctaOption" value="nao">
                            <span>N√£o</span>
                        </label>
                    </div>
                </div>
                
                <div class="field">
                    <label for="carrosselToggle">Carrossel</label>
                    <button type="button" class="chip chip-toggle" id="carrosselToggle" aria-pressed="false" onclick="toggleCarrossel()">
                        Ativar
                    </button>
                </div>
                
                <div class="field" id="carrosselQtyField" style="display: none;">
                    <label for="qtdImagens">Qtd Imagens</label>
                    <div class="qty-control">
                        <button type="button" data-step="-1" aria-label="Diminuir quantidade">‚àí</button>
                        <input type="number" id="qtdImagens" min="2" max="5" value="3" readonly>
                        <button type="button" data-step="1" aria-label="Aumentar quantidade">+</button>
                    </div>
                </div>
            </div>
            
            <!-- LINHA 3: Tema -->
            <div class="field">
                <div class="field-label-with-counter">
                    <label for="temaPost">
                        Tema
                        <span class="text-danger">*</span>
                    </label>
                    <span id="temaContador" class="char-counter">0/3000</span>
                </div>
                <textarea id="temaPost" name="tema" class="form-input-filter" rows="4" 
                          maxlength="3000" placeholder="Restri√ß√µes, exemplos, refer√™ncias..." required></textarea>
            </div>
            
            <!-- LINHA 4: Imagens de Refer√™ncia -->
            <div class="field">
                <label for="refImgs">Imagens de Refer√™ncia</label>
                <div class="upload-area">
                    <input type="file" id="refImgs" accept=".jpg,.jpeg,.png" multiple style="display: none;">
                    <button type="button" class="btn-upload" onclick="document.getElementById('refImgs').click()">
                        <i class="fas fa-cloud-upload-alt mr-2"></i>
                        Escolher Imagens
                    </button>
                    <div id="refImgsInfo" class="upload-info">
                        Nenhum arquivo selecionado ‚Äî M√°x. 5 imagens (.JPG ou .PNG)
                    </div>
                    <div id="refImgsPreview" class="upload-preview"></div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="closeModal('modalGerarPost')">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary" id="btnEnviarPost">
                    Enviar ao agente
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/confirm-modal.js' %}?v=20260202-1008"></script>
<script src="{% static 'js/toaster.js' %}?v=20260202-1008"></script>
<script src="{% static 'js/logger.js' %}?v=20260202-1008"></script>
<script src="{% static 'js/image-preview-loader.js' %}?v=20260202-1008"></script>

<script>
// ============================================================================
// INJETAR DADOS DO BACKEND - DEVE VIR ANTES DO posts.js
// ============================================================================

// Injetar vari√°veis para o posts.js
window.POSTS_WEBHOOK_URL = "{{ posts_webhook_url|escapejs }}";
window.CSRF_TOKEN = "{{ csrf_token|escapejs }}";

// Injetar INITIAL_POSTS de forma segura
try {
    window.INITIAL_POSTS = JSON.parse('{{ posts_json|escapejs }}');
} catch (e) {
    console.error('Erro ao parsear INITIAL_POSTS:', e);
    window.INITIAL_POSTS = [];
}

window.CURRENT_USER = "{{ request.user.email|default:''|escapejs }}";
window.ORGANIZATION_ID = {{ request.user.organization.id|default:0 }};
</script>

{% load static %}
<script src="{% static 'js/posts.js' %}?v=20260203-0245"></script>
<!-- Temporariamente desabilitados para debug -->
<!-- <script src="{% static 'js/posts-modal.js' %}?v=20260203-0129"></script> -->
<!-- <script src="{% static 'js/posts-gallery.js' %}?v=20260203-0129"></script> -->

<script>
// Inicializar lazyload para imagens dos posts
document.addEventListener('DOMContentLoaded', function() {
    if (window.imagePreviewLoader) {
        const postImages = document.querySelectorAll('img[data-lazy-load]');
        postImages.forEach(img => window.imagePreviewLoader.observe(img));
    }
    
    // Verificar se veio da p√°gina de pautas com dados pr√©-preenchidos
    const params = new URLSearchParams(window.location.search);
    
    if (params.get('action') === 'gerar') {
        const rede = params.get('rede');
        const tema = params.get('tema');
        
        // Abrir modal primeiro
        setTimeout(function() {
            openModal('modalGerarPost');
            
            // DEPOIS de abrir, preencher campos (quando j√° existem no DOM)
            setTimeout(function() {
                // Preencher rede
                if (rede) {
                    const redeSelect = document.getElementById('redePost');
                    if (redeSelect) {
                        redeSelect.value = rede.toLowerCase();
                    }
                }
                
                // Preencher tema
                if (tema) {
                    const temaTextarea = document.getElementById('temaPost');
                    if (temaTextarea) {
                        temaTextarea.value = decodeURIComponent(tema);
                    }
                }
                
                // Limpar query params da URL
                setTimeout(function() {
                    window.history.replaceState({}, '', '/posts/');
                }, 300);
            }, 400);
        }, 100);
    }
});
</script>

<script>
// Fun√ß√µes para controlar o modal
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Se for o modal de posts, inicializar carrossel
        if (modalId === 'modalGerarPost') {
            setTimeout(() => {
                const carrosselToggle = document.getElementById('carrosselToggle');
                const carrosselQtyField = document.getElementById('carrosselQtyField');
                
                if (carrosselToggle && carrosselQtyField) {
                    console.log('üîÑ Inicializando carrossel ao abrir modal...');
                    carrosselToggle.classList.remove('active');
                    carrosselToggle.setAttribute('aria-pressed', 'false');
                    carrosselToggle.textContent = 'Ativar';
                    carrosselQtyField.style.display = 'none';
                    console.log('‚úÖ Carrossel inicializado');
                }
            }, 100);
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Fun√ß√£o para toggle do carrossel
function toggleCarrossel() {
    const carrosselToggle = document.getElementById('carrosselToggle');
    const carrosselQtyField = document.getElementById('carrosselQtyField');
    
    if (!carrosselToggle || !carrosselQtyField) {
        console.error('‚ùå Elementos n√£o encontrados');
        return;
    }
    
    // Verificar se est√° desabilitado
    if (carrosselToggle.disabled) {
        console.log('‚ö†Ô∏è Carrossel est√° desabilitado (Feed + Stories selecionado)');
        return;
    }
    
    // Toggle do estado
    const isActive = carrosselToggle.classList.contains('active');
    const newState = !isActive;
    
    console.log('üîÑ Toggle carrossel - novo estado:', newState);
    
    // Atualizar visual
    carrosselToggle.classList.toggle('active', newState);
    carrosselToggle.setAttribute('aria-pressed', newState ? 'true' : 'false');
    carrosselToggle.textContent = newState ? 'Desativar' : 'Ativar';
    carrosselQtyField.style.display = newState ? 'block' : 'none';
    
    console.log('‚úÖ Carrossel atualizado - display:', carrosselQtyField.style.display);
}
</script>
{% endblock %}
