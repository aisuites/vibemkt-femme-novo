{% extends "base/base.html" %}
{% load static %}

{% block title %}Posts{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/posts.css' %}?v=20260202-0955">
<link rel="stylesheet" href="{% static 'css/confirm-modal.css' %}?v=20260202-0955">
<link rel="stylesheet" href="{% static 'css/toaster.css' %}?v=20260202-0955">
{% endblock %}

{% block content %}
<div class="mb-6">
    <!-- Header Principal (igual pÃ¡gina Pautas) -->
    <div class="perfil-header mb-6">
        <div class="header-content">
            <div class="header-text">
                <h1 class="text-3xl font-bold mb-2">ðŸŽ¨ Posts</h1>
                <p class="text-lg opacity-90">
                    Gere posts completos com imagem e legenda usando IA baseada na sua identidade visual 
                    para criar conteÃºdo profissional e engajador para suas redes sociais.
                </p>
            </div>
            <div class="header-actions">
                {% if knowledge_base %}
                    <button type="button" class="btn btn-light btn-lg" data-open="modalGerarPost">
                        <i class="fas fa-magic mr-2"></i>
                        Gerar Post
                    </button>
                {% else %}
                    <a href="{% url 'knowledge:perfil_view' %}" class="btn btn-light btn-lg">
                        <i class="fas fa-cog mr-2"></i>
                        Completar Perfil
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Filtros (igual pÃ¡gina Pautas) -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-6">
            <h3 class="block-title mb-4">
                <i class="fas fa-filter mr-2"></i>
                Filtros
            </h3>
            <form method="get" class="w-full">
                <div class="flex items-center gap-4 w-full">
                    <!-- Campo Data -->
                    <div style="width: 200px; flex-shrink: 0;">
                        <input type="date" name="data" id="filtroData" class="form-input-filter" 
                               value="{{ filtros.data|default:'' }}" placeholder="Data">
                    </div>
                    
                    <!-- Campo Status -->
                    <div style="width: 200px; flex-shrink: 0;">
                        <select name="status" id="filtroStatus" class="form-input-filter">
                            <option value="all">Todos os status</option>
                        </select>
                    </div>
                    
                    <!-- Campo Buscar por TÃ­tulo -->
                    <div style="flex: 1; min-width: 0;">
                        <div class="form-input-wrapper">
                            <input type="text" name="search" id="filtroBusca" class="form-input-filter" 
                                   value="{{ filtros.search|default:'' }}" placeholder="Buscar por tÃ­tulo...">
                            <i class="fas fa-search form-input-icon"></i>
                        </div>
                    </div>
                    
                    <!-- BotÃµes de AÃ§Ã£o -->
                    <div class="flex gap-3" style="flex-shrink: 0;">
                        <button type="button" id="btnBuscarTitulo" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                            Buscar
                        </button>
                        <button type="button" id="btnLimparFiltros" class="btn btn-outline-secondary">
                            <i class="fas fa-eraser"></i>
                            Limpar filtro
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- PaginaÃ§Ã£o (igual pÃ¡gina Pautas - linha 80) -->
    {% if page_obj.has_other_pages %}
    <div class="mb-6" style="background: #1f2937; border-radius: 8px; padding: 16px; display: flex; justify-content: space-between; align-items: center;">
        <div style="color: #9ca3af; font-size: 14px;" id="postPagerInfo">
            PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }} ({{ page_obj.paginator.count }} posts)
        </div>
        
        <div style="display: flex; gap: 8px; align-items: center;" id="pagerButtons">
            <!-- Primeira pÃ¡gina -->
            <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               style="padding: 8px 12px; background: {% if page_obj.number == 1 %}#6366f1{% else %}transparent{% endif %}; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                Â«
            </a>
            
            <!-- PÃ¡gina anterior -->
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               style="padding: 8px 12px; background: transparent; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                â€¹
            </a>
            {% endif %}
            
            <!-- NÃºmeros de pÃ¡gina -->
            {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                    <span style="padding: 8px 12px; background: #6366f1; border: 1px solid #6366f1; border-radius: 6px; color: #fff; min-width: 40px; text-align: center; font-weight: 500;">
                        {{ num }}
                    </span>
                {% elif num > page_obj.number|add:'-4' and num < page_obj.number|add:'4' %}
                    <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       style="padding: 8px 12px; background: transparent; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                        {{ num }}
                    </a>
                {% endif %}
            {% endfor %}
            
            <!-- PrÃ³xima pÃ¡gina -->
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               style="padding: 8px 12px; background: transparent; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                â€º
            </a>
            {% endif %}
            
            <!-- Ãšltima pÃ¡gina -->
            <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               style="padding: 8px 12px; background: {% if page_obj.number == page_obj.paginator.num_pages %}#6366f1{% else %}transparent{% endif %}; border: 1px solid #374151; border-radius: 6px; color: #fff; text-decoration: none; min-width: 40px; text-align: center;">
                Â»
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Lista de Posts -->
    <div class="grid grid-cols-1 gap-4" id="posts-container">
        {% for post in page_obj %}
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <!-- TODO: Implementar card de post -->
                    <p class="text-muted">Card de post #{{ post.id }} - Em desenvolvimento</p>
                </div>
            </div>
        {% empty %}
            <div class="col-span-full">
                <div class="text-center py-12">
                    <i class="fas fa-images text-6xl text-muted mb-4"></i>
                    <h4 class="text-xl text-muted mb-2">Nenhum post encontrado</h4>
                    <p class="text-muted">
                        {% if knowledge_base %}
                            Clique em "Gerar Post" para criar seu primeiro post com IA.
                        {% else %}
                            Complete o perfil da sua empresa para comeÃ§ar a gerar posts.
                        {% endif %}
                    </p>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Gerar Post -->
<div id="modalGerarPost" class="posts-modal" aria-hidden="true">
    <div class="panel">
        <div class="head">
            <h3>Gerar Post</h3>
            <button type="button" class="close" data-close aria-label="Fechar">Ã—</button>
        </div>
        
        <form id="formGerarPost" class="posts-form">
            <!-- TODO: Implementar formulÃ¡rio completo -->
            <p class="text-muted">FormulÃ¡rio em desenvolvimento</p>
            
            <div class="form-footer">
                <button type="button" class="btn-posts ghost" data-close>Cancelar</button>
                <button type="submit" class="btn-posts">Gerar Post</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/confirm-modal.js' %}?v=20260202-0955"></script>
<script src="{% static 'js/toaster.js' %}?v=20260202-0955"></script>
<script src="{% static 'js/logger.js' %}?v=20260202-0955"></script>
<script src="{% static 'js/posts.js' %}?v=20260202-0955"></script>

<script>
// Injetar variÃ¡veis para o posts.js
window.POSTS_WEBHOOK_URL = "{{ posts_webhook_url|escapejs }}";
window.CSRF_TOKEN = "{{ csrf_token|escapejs }}";
window.INITIAL_POSTS = {{ posts_json|safe }};
window.CURRENT_USER = "{{ request.user.email|default:''|escapejs }}";
window.ORGANIZATION_ID = {{ request.user.organization.id|default:0 }};
</script>
{% endblock %}
