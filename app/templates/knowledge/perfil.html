{% extends 'base/base.html' %}
{% load static %}

{% block title %}Perfil da Empresa - IAMKT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/perfil.css' %}?v=20260128-1557">
<link rel="stylesheet" href="{% static 'css/logo-upload-widget.css' %}?v=20260129-1605">
{% endblock %}

{% block content %}
<div class="perfil-container">
    
    {% if analysis_status == 'pending' %}
        <!-- ESTADO 1: Pendente - Redirecionar para Base IAMKT -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">üìã</div>
            <h2 class="perfil-empty-title">Base IAMKT Incompleta</h2>
            <p class="perfil-empty-text">
                Complete sua Base de Conhecimento para solicitar a an√°lise do agente IAMKT.
            </p>
            <a href="{% url 'knowledge:view' %}" class="btn btn-primary">
                Ir para Base IAMKT
            </a>
        </div>
    
    {% elif analysis_status == 'processing' %}
        <!-- ESTADO 3: Processando An√°lise -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">‚è≥</div>
            <h2 class="perfil-empty-title">BASE EM PROCESSAMENTO</h2>
            <p class="perfil-empty-text">
                Sua Base est√° sendo analisada pelo nosso agente de IA e estar√° dispon√≠vel em breve.
            </p>
            <button id="btn-check-analysis" class="btn btn-primary" onclick="window.location.reload()">
                Verificar se est√° Dispon√≠vel
            </button>
        </div>
    
    {% elif analysis_status == 'completed' %}
        <!-- ESTADO 4: Modo Edi√ß√£o (An√°lise Recebida) -->
        
        <!-- Header com Logo + Instru√ß√µes -->
        <div class="perfil-header">
            <div class="perfil-header-left">
                {% include 'components/logo_upload_widget.html' with logo=primary_logo widget_id='perfil-logo' show_label=False compact=True %}
            </div>
            <div class="perfil-header-right">
                <h1 class="perfil-title">Perfil da Empresa</h1>
                <p class="perfil-instructions">
                    Revise os blocos abaixo: compare o que foi <strong>informado</strong> 
                    com a <strong>avalia√ß√£o</strong> do agente e, quando houver, 
                    analise a <strong>sugest√£o</strong>. Voc√™ pode seguir mesmo sem 
                    aceitar ou editar nenhum campo. Caso edite ou aceite alguma sugest√£o, 
                    enviaremos apenas o que mudou para o agente.
                </p>
            </div>
        </div>
        
        <!-- Resumo Geral -->
        <div class="analysis-summary">
            <h3 class="analysis-summary-title">üìä Resumo da An√°lise</h3>
            <div class="analysis-summary-stats">
                <div class="stat-item stat-danger">
                    <span class="stat-number">{{ stats.fraco }}</span>
                    <span class="stat-label">campos fracos</span>
                </div>
                <div class="stat-item stat-warning">
                    <span class="stat-number">{{ stats.medio }}</span>
                    <span class="stat-label">campos m√©dios</span>
                </div>
                <div class="stat-item stat-success">
                    <span class="stat-number">{{ stats.bom }}</span>
                    <span class="stat-label">campos bons</span>
                </div>
            </div>
        </div>
        
        <!-- Lista de Cards de An√°lise -->
        <div class="analysis-cards-list">
            {% for campo_nome, campo_data in campos_analise.items %}
            <div class="analysis-card" data-field="{{ campo_nome }}">
                <div class="analysis-card-header">
                    <div>
                        <h3 class="analysis-card-title">{{ campo_data.label }}</h3>
                        <p class="analysis-card-subtitle">Bloco avaliado pelo agente</p>
                    </div>
                    {% if campo_data.status == 'fraco' %}
                        <span class="badge badge-danger">fraco</span>
                    {% elif campo_data.status == 'm√©dio' %}
                        <span class="badge badge-warning">m√©dio</span>
                    {% elif campo_data.status == 'bom' %}
                        <span class="badge badge-success">bom</span>
                    {% endif %}
                </div>
                
                <div class="analysis-card-body">
                    <div class="analysis-section">
                        <label class="analysis-label">INFORMADO</label>
                        <div class="analysis-content">{{ campo_data.informado|default:"" }}</div>
                    </div>
                    
                    <div class="analysis-section">
                        <label class="analysis-label">AVALIA√á√ÉO</label>
                        <div class="analysis-content">{{ campo_data.avaliacao }}</div>
                    </div>
                    
                    {% if campo_data.sugestao %}
                    <div class="analysis-section analysis-section-full">
                        <label class="analysis-label">SUGEST√ÉO DO AGENTE</label>
                        <div class="analysis-content">{{ campo_data.sugestao }}</div>
                    </div>
                    {% endif %}
                </div>
                
                {% if campo_data.sugestao %}
                <div class="analysis-card-actions">
                    <button class="btn-action btn-action-accept">
                        ‚úì Aceitar
                    </button>
                    <button class="btn-action btn-action-reject">
                        ‚úó Rejeitar
                    </button>
                </div>
                
                <div class="analysis-feedback analysis-feedback-accepted">
                    Voc√™ marcou esta sugest√£o como ACEITA.
                </div>
                <div class="analysis-feedback analysis-feedback-rejected">
                    Voc√™ rejeitou esta sugest√£o.
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <!-- Bot√£o Final -->
        <div class="perfil-actions">
            <button id="btn-submit-suggestions" class="btn btn-primary btn-lg" disabled>
                Aplicar Sugest√µes Selecionadas <span class="counter">0</span>
            </button>
        </div>
    
    {% elif analysis_status == 'compiling' %}
        <!-- ESTADO 5: Processando Compila√ß√£o -->
        <div class="perfil-loading">
            <div class="perfil-loading-spinner"></div>
            <h2 class="perfil-loading-text">Gerando seu plano de marketing...</h2>
            <p class="text-muted-spaced">
                Quase l√°! Estamos compilando todas as informa√ß√µes.
            </p>
        </div>
    
    {% elif analysis_status == 'compiled' %}
        <!-- ESTADO 6: Modo Visualiza√ß√£o (Compila√ß√£o Recebida) -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">‚úÖ</div>
            <h2 class="perfil-empty-title">Plano de Marketing Gerado!</h2>
            <p class="perfil-empty-text">
                Modo visualiza√ß√£o ser√° implementado na pr√≥xima fase.
            </p>
        </div>
    
    {% elif analysis_status == 'error' %}
        <!-- ESTADO: Erro -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">‚ö†Ô∏è</div>
            <h2 class="perfil-empty-title">Erro ao Processar</h2>
            <p class="perfil-empty-text">
                Ocorreu um erro ao processar sua solicita√ß√£o. Por favor, tente novamente.
            </p>
            <a href="{% url 'knowledge:view' %}" class="btn btn-primary">
                Voltar para Base IAMKT
            </a>
        </div>
    
    {% else %}
        <!-- Estado desconhecido -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">‚ùì</div>
            <h2 class="perfil-empty-title">Estado Desconhecido</h2>
            <p class="perfil-empty-text">Status: {{ analysis_status }}</p>
        </div>
    {% endif %}
    
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/logger.js' %}?v=20260128-1154"></script>
<script src="{% static 'js/toaster.js' %}?v=20260128-1154"></script>
<script src="{% static 'js/image-validator.js' %}?v=20260128-1154"></script>
<script src="{% static 'js/image-preview-loader.js' %}?v=20260129-1605"></script>
<script src="{% static 'js/uploads-simple.js' %}?v=20260128-1154"></script>
<script src="{% static 'js/confirm-modal.js' %}?v=20260128-1557"></script>
<script src="{% static 'js/perfil.js' %}"></script>
<script>
// Inicializar upload de logotipo no Perfil
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar image preview loader global
    if (!window.imagePreviewLoader) {
        window.imagePreviewLoader = new ImagePreviewLoader('/knowledge/preview-url/');
    }
    
    // Inicializar validadores
    if (!UploadConfig.validators.logos) {
        UploadConfig.validators.logos = new ImageValidator('logos');
    }
    
    // Input de upload
    const logoInput = document.getElementById('perfil-logo-input');
    if (logoInput) {
        logoInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                // Validar
                const validator = UploadConfig.validators.logos;
                const validation = await validator.validate(file);
                
                if (!validation.valid) {
                    toaster.error(validation.errors.join(', '));
                    return;
                }
                
                // Mostrar loading
                const widget = document.getElementById('perfil-logo');
                const placeholder = widget.querySelector('.logo-upload-placeholder');
                if (placeholder) {
                    placeholder.innerHTML = '<div class="spinner"></div><p>Enviando...</p>';
                }
                
                // Upload imediato para S3
                const result = await uploadFileToS3(
                    file,
                    'logo',
                    UploadConfig.endpoints.logoUploadUrl,
                    UploadConfig.endpoints.logoCreate
                );
                
                toaster.success('Logotipo enviado com sucesso!');
                
                // Recarregar p√°gina para mostrar preview
                setTimeout(() => window.location.reload(), 1000);
                
            } catch (error) {
                console.error('Erro no upload:', error);
                toaster.error(error.message || 'Erro ao enviar logotipo');
                
                // Restaurar UI
                const widget = document.getElementById('perfil-logo');
                const placeholder = widget.querySelector('.logo-upload-placeholder');
                if (placeholder) {
                    location.reload(); // Restaurar estado original
                }
            }
            
            e.target.value = '';
        });
    }
    
    // Bot√£o "Escolher arquivo"
    document.addEventListener('click', function(e) {
        if (e.target.matches('[data-action="select-logo"]') || e.target.closest('[data-action="select-logo"]')) {
            e.preventDefault();
            logoInput?.click();
        }
        
        // Remover logotipo
        if (e.target.matches('[data-action="remove-logo"]') || e.target.closest('[data-action="remove-logo"]')) {
            e.preventDefault();
            const button = e.target.closest('[data-action="remove-logo"]');
            const logoId = button.dataset.logoId;
            
            if (!logoId) return;
            
            confirmModal.show({
                title: 'Remover logotipo?',
                message: 'Esta a√ß√£o n√£o pode ser desfeita.',
                confirmText: 'Remover',
                cancelText: 'Cancelar',
                type: 'danger'
            }).then(async (confirmed) => {
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/knowledge/logo/${logoId}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao remover logotipo');
                    }
                    
                    toaster.success('Logotipo removido com sucesso!');
                    setTimeout(() => window.location.reload(), 1000);
                    
                } catch (error) {
                    console.error('Erro ao remover:', error);
                    toaster.error('Erro ao remover logotipo');
                }
            });
        }
    });
    
    // Drag and drop
    const uploadArea = document.querySelector('#perfil-logo .logo-upload-empty');
    if (uploadArea && logoInput) {
        setupDragAndDrop(uploadArea, 'perfil-logo-input');
    }
    
    // Helper para CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
