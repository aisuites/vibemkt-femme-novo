{% extends 'base/base.html' %}
{% load static %}

{% block title %}Perfil da Empresa - IAMKT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/perfil.css' %}?v=20260131-1301">
<link rel="stylesheet" href="{% static 'css/perfil-colors.css' %}?v=20260131-1511">
<link rel="stylesheet" href="{% static 'css/perfil-fonts.css' %}?v=20260131-1616">
<link rel="stylesheet" href="{% static 'css/perfil-logos.css' %}?v=20260131-1629">
<link rel="stylesheet" href="{% static 'css/knowledge.css' %}?v=20260131-1502">
<link rel="stylesheet" href="{% static 'css/logo-upload-widget.css' %}?v=20260129-1703">
<link rel="stylesheet" href="{% static 'css/confirm-modal.css' %}?v=20260129-1703">
{% endblock %}

{% block content %}
<div class="perfil-container">
    
    {% if analysis_status == 'pending' %}
        <!-- ESTADO 1: Pendente - Redirecionar para Base IAMKT -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">üìã</div>
            <h2 class="perfil-empty-title">Base IAMKT Incompleta</h2>
            <p class="perfil-empty-text">
                Complete sua Base de Conhecimento para solicitar a an√°lise do agente IAMKT.
            </p>
            <a href="{% url 'knowledge:view' %}" class="btn btn-primary">
                Ir para Base IAMKT
            </a>
        </div>
    
    {% elif analysis_status == 'processing' %}
        <!-- ESTADO 3: Processando An√°lise -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">‚è≥</div>
            <h2 class="perfil-empty-title">BASE EM PROCESSAMENTO</h2>
            <p class="perfil-empty-text">
                Sua Base est√° sendo analisada pelo nosso agente de IA e estar√° dispon√≠vel em breve.
            </p>
            <button id="btn-check-analysis" class="btn btn-primary" onclick="window.location.reload()">
                Verificar se est√° Dispon√≠vel
            </button>
        </div>
    
    {% elif compilation_status == 'processing' %}
        <!-- ESTADO 3.5: Aguardando Compila√ß√£o (ap√≥s aplicar sugest√µes) -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">üîÑ</div>
            <h2 class="perfil-empty-title">COMPILANDO SUA BASE</h2>
            <p class="perfil-empty-text">
                Suas altera√ß√µes est√£o sendo processadas e sua base est√° sendo compilada. Isso pode levar alguns minutos.
            </p>
            <button id="btn-check-compilation" class="btn btn-primary" onclick="window.location.reload()">
                Verificar se est√° Pronto
            </button>
        </div>
    
    {% elif analysis_status == 'completed' %}
        <!-- ESTADO 4: Modo Edi√ß√£o (An√°lise Recebida) -->
        
        <!-- Header com Logo + Instru√ß√µes -->
        <div class="perfil-header">
            <div class="perfil-header-left">
                {% include 'components/logo_upload_widget.html' with logo=primary_logo widget_id='perfil-logo' show_label=False compact=True %}
            </div>
            <div class="perfil-header-right">
                <h1 class="perfil-title">Perfil da Empresa</h1>
                <p class="perfil-instructions">
                    Revise os blocos abaixo: compare o que foi <strong>informado</strong> 
                    com a <strong>avalia√ß√£o</strong> do agente e, quando houver, 
                    analise a <strong>sugest√£o</strong>. Voc√™ pode seguir mesmo sem 
                    aceitar ou editar nenhum campo. Caso edite ou aceite alguma sugest√£o, 
                    enviaremos apenas o que mudou para o agente.
                </p>
                <div class="analysis-summary">
                <h3 class="analysis-summary-title">üìä Resumo da An√°lise</h3>
                <div class="analysis-summary-stats">
                    <div class="stat-item stat-danger">
                        <span class="stat-number">{{ stats.fraco }}</span>
                        <span class="stat-label">campos fracos</span>
                    </div>
                    <div class="stat-item stat-warning">
                        <span class="stat-number">{{ stats.medio }}</span>
                        <span class="stat-label">campos m√©dios</span>
                    </div>
                    <div class="stat-item stat-success">
                        <span class="stat-number">{{ stats.bom }}</span>
                        <span class="stat-label">campos bons</span>
                    </div>
                </div>
        </div>
    
            </div>
        </div>
        
        <!-- Resumo Geral
        <div class="analysis-summary">
            <h3 class="analysis-summary-title">üìä Resumo da An√°lise</h3>
            <div class="analysis-summary-stats">
                <div class="stat-item stat-danger">
                    <span class="stat-number">{{ stats.fraco }}</span>
                    <span class="stat-label">campos fracos</span>
                </div>
                <div class="stat-item stat-warning">
                    <span class="stat-number">{{ stats.medio }}</span>
                    <span class="stat-label">campos m√©dios</span>
                </div>
                <div class="stat-item stat-success">
                    <span class="stat-number">{{ stats.bom }}</span>
                    <span class="stat-label">campos bons</span>
                </div>
            </div>
        </div> -->
        
        <!-- Lista de Cards de An√°lise Agrupados por Bloco -->
        <div class="analysis-cards-list">
            {% for bloco in blocos_analise %}
            <!-- Cabe√ßalho do Bloco -->
            <div class="analysis-block-header">
                <div class="form-block-kicker">Bloco {{ bloco.numero }} - {{ bloco.titulo }}</div>
            </div>
            
            <!-- Campos do Bloco -->
            {% for campo in bloco.campos %}
            <div class="analysis-card" data-field="{{ campo.nome }}">
                <div class="analysis-card-header">
                    <div>
                        <h3 class="analysis-card-title">{{ campo.label }}</h3>
                        <p class="analysis-card-subtitle">Campo avaliado pelo agente</p>
                    </div>
                    {% if campo.status == 'fraco' %}
                        <span class="badge badge-danger">fraco</span>
                    {% elif campo.status == 'm√©dio' %}
                        <span class="badge badge-warning">m√©dio</span>
                    {% elif campo.status == 'bom' %}
                        <span class="badge badge-success">bom</span>
                    {% elif campo.status == 'muito bom' %}
                        <span class="badge badge-success">muito bom</span>
                    {% endif %}
                </div>
                
                <div class="analysis-card-body">
                    <div class="analysis-section">
                        <label class="analysis-label">INFORMADO</label>
                        {% if campo.nome == 'recommended_words' or campo.nome == 'words_to_avoid' %}
                        <!-- Layout de Tags para Palavras -->
                        <div class="tags-input-wrapper" data-field="{{ campo.nome }}">
                            <div class="tags-container" id="tags-{{ campo.nome }}" data-tags="{{ campo.informado|default:'[]' }}"></div>
                            <input type="text" 
                                   class="tag-input" 
                                   data-target="tags-{{ campo.nome }}"
                                   placeholder="Digite e pressione Enter para adicionar">
                        </div>
                        {% elif campo.type == 'colors' %}
                        <!-- Layout de Cores - Estilo Minimalista -->
                        <div class="perfil-colors-wrapper">
                            <div id="perfil-color-list" class="perfil-color-list">
                                {% for color in campo.colors %}
                                <div class="perfil-color-item" data-color-id="{{ color.id }}">
                                    <div class="perfil-color-preview" style="background-color: {{ color.hex_code }};"></div>
                                    <span class="perfil-color-hex">{{ color.hex_code }}</span>
                                    <button type="button" 
                                            class="perfil-color-remove" 
                                            onclick="removePerfilColor({{ color.id }})"
                                            title="Remover cor">√ó</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" 
                                    class="perfil-btn-add-color" 
                                    onclick="addPerfilColor()">+ cor</button>
                        </div>
                        {% elif campo.type == 'fonts' %}
                        <!-- Layout de Fontes - Pills com Nome + Uso + X -->
                        <div class="perfil-fonts-wrapper">
                            <div id="perfil-font-list" class="perfil-font-list">
                                {% for font in campo.fonts %}
                                <div class="perfil-font-item" data-font-id="{{ font.id }}">
                                    <span class="perfil-font-name">{{ font.font_name }}</span>
                                    <span class="perfil-font-usage">{{ font.usage }}</span>
                                    <button type="button" 
                                            class="perfil-font-remove" 
                                            onclick="removePerfilFont({{ font.id }})"
                                            title="Remover fonte">√ó</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" 
                                    class="perfil-btn-add-font" 
                                    onclick="addPerfilFont()">+ fonte</button>
                        </div>
                        {% elif campo.type == 'logos' %}
                        <!-- Layout de Logotipos - Grid de Thumbnails -->
                        <div class="perfil-logos-wrapper">
                            <div id="perfil-logos-grid" class="perfil-logos-grid">
                                {% for logo in campo.logos %}
                                <div class="perfil-logo-item" data-logo-id="{{ logo.id }}" data-s3-key="{{ logo.s3_key }}">
                                    <img src="#" alt="{{ logo.name }}" class="perfil-logo-img" data-lazy-load="{{ logo.s3_key }}">
                                    <button type="button" 
                                            class="perfil-logo-remove" 
                                            onclick="removePerfilLogo({{ logo.id }})"
                                            title="Remover logo">√ó</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" 
                                    class="perfil-btn-add-logo" 
                                    onclick="addPerfilLogo()">Adicionar logo</button>
                        </div>
                        {% elif campo.type == 'references' %}
                        <!-- Layout de Imagens de Refer√™ncia - Grid de Thumbnails -->
                        <div class="perfil-references-wrapper">
                            <div id="perfil-references-grid" class="perfil-references-grid">
                                {% for ref in campo.references %}
                                <div class="perfil-reference-item" data-ref-id="{{ ref.id }}" data-s3-key="{{ ref.s3_key }}">
                                    <img src="#" alt="{{ ref.title }}" class="perfil-reference-img" data-lazy-load="{{ ref.s3_key }}">
                                    <button type="button" 
                                            class="perfil-reference-remove" 
                                            onclick="removePerfilReference({{ ref.id }})"
                                            title="Remover imagem">√ó</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" 
                                    class="perfil-btn-add-reference" 
                                    onclick="addPerfilReference()">Adicionar imagem</button>
                        </div>
                        {% elif campo.type == 'website' %}
                        <!-- Layout de Site Institucional - √çcone + https:// fixo -->
                        <div class="social-network-field">
                            <div class="social-network-icon website">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                </svg>
                            </div>
                            <div class="website-field-wrapper">
                                <span class="website-prefix">https://</span>
                                <input type="text" 
                                       class="editable-field" 
                                       data-field="{{ campo.nome }}"
                                       data-original="{% if campo.informado and campo.informado != 'N√£o informado' %}{{ campo.informado|slice:'8:' }}{% endif %}"
                                       value="{% if campo.informado and campo.informado != 'N√£o informado' %}{{ campo.informado|slice:'8:' }}{% endif %}"
                                       placeholder="femme.com.br">
                            </div>
                        </div>
                        {% elif campo.type == 'competitors' %}
                        <!-- Layout de Concorrentes - Linhas din√¢micas com nome + URL -->
                        <div class="concorrentes-container">
                            <!-- Campo hidden para armazenar JSON -->
                            <input type="hidden" id="concorrentes_data_perfil" name="concorrentes" value="">
                            
                            <!-- Container para linhas de concorrentes -->
                            <div id="concorrentes-inputs-container-perfil" class="concorrentes-inputs-container">
                                <!-- Linhas ser√£o adicionadas dinamicamente -->
                            </div>
                            
                            <!-- Bot√£o para adicionar nova linha -->
                            <button type="button" class="btn-add-item" onclick="addConcorrenteLinePerfil()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Adicionar Concorrente
                            </button>
                            
                            <!-- Script para inicializar concorrentes existentes -->
                            <script>
                            (function() {
                                const competitorsData = {{ campo.competitors_data|safe|default:"[]" }};
                                if (typeof initConcorrentesPerfil === 'function') {
                                    initConcorrentesPerfil(competitorsData);
                                } else {
                                    // Se a fun√ß√£o ainda n√£o foi carregada, aguardar
                                    document.addEventListener('DOMContentLoaded', function() {
                                        if (typeof initConcorrentesPerfil === 'function') {
                                            initConcorrentesPerfil(competitorsData);
                                        }
                                    });
                                }
                            })();
                            </script>
                        </div>
                        {% elif campo.type == 'social_networks' %}
                        <!-- Layout de Redes Sociais - Todas as redes com √≠cone + https:// fixo -->
                        <div class="social-networks-manager">
                            <!-- Instagram -->
                            <div class="social-network-field">
                                <div class="social-network-icon instagram">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                    </svg>
                                </div>
                                <div class="website-field-wrapper">
                                    <span class="website-prefix">https://</span>
                                    <input type="text" 
                                           name="social_instagram_domain"
                                           data-original="{% if campo.social_networks_data.instagram %}{{ campo.social_networks_data.instagram|slice:'8:' }}{% endif %}"
                                           value="{% if campo.social_networks_data.instagram %}{{ campo.social_networks_data.instagram|slice:'8:' }}{% endif %}"
                                           placeholder="instagram.com/femme">
                                </div>
                            </div>
                            
                            <!-- Facebook -->
                            <div class="social-network-field">
                                <div class="social-network-icon facebook">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.853 0 2.136 1.445 2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                    </svg>
                                </div>
                                <div class="website-field-wrapper">
                                    <span class="website-prefix">https://</span>
                                    <input type="text" 
                                           name="social_facebook_domain"
                                           data-original="{% if campo.social_networks_data.facebook %}{{ campo.social_networks_data.facebook|slice:'8:' }}{% endif %}"
                                           value="{% if campo.social_networks_data.facebook %}{{ campo.social_networks_data.facebook|slice:'8:' }}{% endif %}"
                                           placeholder="facebook.com/femme">
                                </div>
                            </div>
                            
                            <!-- LinkedIn -->
                            <div class="social-network-field">
                                <div class="social-network-icon linkedin">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                    </svg>
                                </div>
                                <div class="website-field-wrapper">
                                    <span class="website-prefix">https://</span>
                                    <input type="text" 
                                           name="social_linkedin_domain"
                                           data-original="{% if campo.social_networks_data.linkedin %}{{ campo.social_networks_data.linkedin|slice:'8:' }}{% endif %}"
                                           value="{% if campo.social_networks_data.linkedin %}{{ campo.social_networks_data.linkedin|slice:'8:' }}{% endif %}"
                                           placeholder="linkedin.com/company/femme">
                                </div>
                            </div>
                            
                            <!-- YouTube -->
                            <div class="social-network-field">
                                <div class="social-network-icon youtube">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                    </svg>
                                </div>
                                <div class="website-field-wrapper">
                                    <span class="website-prefix">https://</span>
                                    <input type="text" 
                                           name="social_youtube_domain"
                                           data-original="{% if campo.social_networks_data.youtube %}{{ campo.social_networks_data.youtube|slice:'8:' }}{% endif %}"
                                           value="{% if campo.social_networks_data.youtube %}{{ campo.social_networks_data.youtube|slice:'8:' }}{% endif %}"
                                           placeholder="youtube.com/@femme">
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <textarea class="analysis-value editable-field" 
                                  data-field="{{ campo.nome }}"
                                  data-original="{{ campo.informado|default:'' }}"
                                  rows="3">{{ campo.informado|default:"N√£o informado" }}</textarea>
                        {% endif %}
                    </div>
                    
                    <div class="analysis-section">
                        <label class="analysis-label">AVALIA√á√ÉO</label>
                        <div class="analysis-evaluation">{{ campo.avaliacao }}</div>
                    </div>
                    
                    {% if campo.sugestao %}
                    <div class="analysis-section">
                        <label class="analysis-label">SUGEST√ÉO</label>
                        <div class="analysis-suggestion">{{ campo.sugestao }}</div>
                        {% if not campo.readonly and not campo.no_suggestions %}
                        <div class="analysis-actions">
                            <button type="button" class="btn-action btn-action-accept" data-action="accept-suggestion" data-field="{{ campo.nome }}">
                                ‚úì Aceitar Sugest√£o
                            </button>
                            <button type="button" class="btn-action btn-action-reject" data-action="reject-suggestion" data-field="{{ campo.nome }}">
                                √ó Rejeitar
                            </button>
                        </div>
                        <!-- Feedback visual -->
                        <div class="analysis-feedback analysis-feedback-accepted">
                            ‚úì Voc√™ marcou esta sugest√£o como ACEITA.
                        </div>
                        <div class="analysis-feedback analysis-feedback-rejected">
                            √ó Voc√™ rejeitou esta sugest√£o.
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endfor %}
        </div>
        
        <!-- Bot√£o Final -->
        <div class="perfil-actions">
            <button id="btn-submit-suggestions" class="btn btn-primary btn-lg" disabled>
                Aplicar Sugest√µes Selecionadas <span class="counter">0</span>
            </button>
        </div>
    
    {% elif analysis_status == 'compiling' %}
        <!-- ESTADO 5: Processando Compila√ß√£o -->
        <div class="perfil-loading">
            <div class="perfil-loading-spinner"></div>
            <h2 class="perfil-loading-text">Gerando seu plano de marketing...</h2>
            <p class="text-muted-spaced">
                Quase l√°! Estamos compilando todas as informa√ß√µes.
            </p>
        </div>
    
    {% elif analysis_status == 'compiled' %}
        <!-- ESTADO 6: Modo Visualiza√ß√£o (Compila√ß√£o Recebida) -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">‚úÖ</div>
            <h2 class="perfil-empty-title">Plano de Marketing Gerado!</h2>
            <p class="perfil-empty-text">
                Modo visualiza√ß√£o ser√° implementado na pr√≥xima fase.
            </p>
        </div>
    
    {% elif analysis_status == 'error' %}
        <!-- ESTADO: Erro -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">‚ö†Ô∏è</div>
            <h2 class="perfil-empty-title">Erro ao Processar</h2>
            <p class="perfil-empty-text">
                Ocorreu um erro ao processar sua solicita√ß√£o. Por favor, tente novamente.
            </p>
            <a href="{% url 'knowledge:view' %}" class="btn btn-primary">
                Voltar para Base IAMKT
            </a>
        </div>
    
    {% else %}
        <!-- Estado desconhecido -->
        <div class="perfil-empty">
            <div class="perfil-empty-icon">‚ùì</div>
            <h2 class="perfil-empty-title">Estado Desconhecido</h2>
            <p class="perfil-empty-text">Status: {{ analysis_status }}</p>
        </div>
    {% endif %}
    
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/logger.js' %}?v=20260129-1627"></script>
<script src="{% static 'js/toaster.js' %}?v=20260129-1627"></script>
<script src="{% static 'js/image-validator.js' %}?v=20260129-1627"></script>
<script src="{% static 'js/image-preview-loader.js' %}?v=20260129-1627"></script>
<script src="{% static 'js/uploads-simple.js' %}?v=20260129-1627"></script>
<script src="{% static 'js/confirm-modal.js' %}?v=20260129-1627"></script>
<script src="{% static 'js/perfil-tags.js' %}?v=20260131-1502"></script>
<script src="{% static 'js/perfil-colors.js' %}?v=20260131-1518"></script>
<script src="{% static 'js/perfil-fonts.js' %}?v=20260131-1616"></script>
<script src="{% static 'js/perfil-logos.js' %}?v=20260131-1629"></script>
<script src="{% static 'js/perfil-references.js' %}?v=20260131-1649"></script>
<script src="{% static 'js/perfil-social.js' %}?v=20260131-1816"></script>
<script src="{% static 'js/perfil-competitors.js' %}?v=20260131-1852"></script>
<script src="{% static 'js/perfil.js' %}?v=20260131-1335"></script>
<script>
// Inicializar upload de logotipo no Perfil
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar image preview loader global
    if (!window.imagePreviewLoader) {
        window.imagePreviewLoader = new ImagePreviewLoader('/knowledge/preview-url/');
    }
    
    // Observar imagens de logos no Perfil
    const logoImages = document.querySelectorAll('#perfil-logos-grid img[data-lazy-load]');
    if (logoImages.length > 0 && window.imagePreviewLoader) {
        logoImages.forEach(img => window.imagePreviewLoader.observe(img));
    }
    
    // Observar imagens de refer√™ncia no Perfil
    const referenceImages = document.querySelectorAll('#perfil-references-grid img[data-lazy-load]');
    if (referenceImages.length > 0 && window.imagePreviewLoader) {
        referenceImages.forEach(img => window.imagePreviewLoader.observe(img));
    }
    
    // Inicializar validadores
    if (!UploadConfig.validators.logos) {
        UploadConfig.validators.logos = new ImageValidator('logos');
    }
    
    // Input de upload
    const logoInput = document.getElementById('perfil-logo-input');
    if (logoInput) {
        logoInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                // Validar
                const validator = UploadConfig.validators.logos;
                const validation = await validator.validate(file);
                
                if (!validation.valid) {
                    toaster.error(validation.errors.join(', '));
                    return;
                }
                
                // Mostrar loading
                const widget = document.getElementById('perfil-logo');
                const placeholder = widget.querySelector('.logo-upload-placeholder');
                if (placeholder) {
                    placeholder.innerHTML = '<div class="spinner"></div><p>Enviando...</p>';
                }
                
                // Upload imediato para S3
                const result = await uploadFileToS3(
                    file,
                    'logo',
                    UploadConfig.endpoints.logoUploadUrl,
                    UploadConfig.endpoints.logoCreate
                );
                
                toaster.success('Logotipo enviado com sucesso!');
                
                // Recarregar p√°gina para mostrar preview
                setTimeout(() => window.location.reload(), 1000);
                
            } catch (error) {
                console.error('Erro no upload:', error);
                toaster.error(error.message || 'Erro ao enviar logotipo');
                
                // Restaurar UI
                const widget = document.getElementById('perfil-logo');
                const placeholder = widget.querySelector('.logo-upload-placeholder');
                if (placeholder) {
                    location.reload(); // Restaurar estado original
                }
            }
            
            e.target.value = '';
        });
    }
    
    // Bot√£o "Escolher arquivo"
    document.addEventListener('click', function(e) {
        if (e.target.matches('[data-action="select-logo"]') || e.target.closest('[data-action="select-logo"]')) {
            e.preventDefault();
            logoInput?.click();
        }
        
        // Remover logotipo
        if (e.target.matches('[data-action="remove-logo"]') || e.target.closest('[data-action="remove-logo"]')) {
            e.preventDefault();
            const button = e.target.closest('[data-action="remove-logo"]');
            const logoId = button.dataset.logoId;
            
            if (!logoId) return;
            
            confirmModal.show('Esta a√ß√£o n√£o pode ser desfeita.', 'Remover logotipo?').then(async (confirmed) => {
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/knowledge/logo/${logoId}/delete/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao remover logotipo');
                    }
                    
                    toaster.success('Logotipo removido com sucesso!');
                    setTimeout(() => window.location.reload(), 1000);
                    
                } catch (error) {
                    console.error('Erro ao remover:', error);
                    toaster.error('Erro ao remover logotipo');
                }
            });
        }
    });
    
    // Drag and drop
    const uploadArea = document.querySelector('#perfil-logo .logo-upload-empty');
    if (uploadArea && logoInput) {
        setupDragAndDrop(uploadArea, 'perfil-logo-input');
    }
    
    // Helper para CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
